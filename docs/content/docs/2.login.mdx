---
title: Login
description: User login and registration flow
---

# Authentication

Complete user authentication flow with automatic method detection.

## Flow Overview

1. **Check User** → Determine authentication method
2. **Login** → Use password or OTP based on response
3. **Access** → Protected routes with JWT cookies

## 1. Check Authentication Method

First, check if user exists and determine login method.

### Endpoint

```http
POST /api/account/authenticate/check/
```

### Request

```json
{
  "phone": "09123456789"
}
```

### Response

**User has password:**

```json
{
  "success": true,
  "status": 200,
  "message": "عملیات با موفقیت انجام شد",
  "data": { "section": "PASSWORD" }
}
```

**User needs OTP (not registered or no password):**

```json
{
  "success": true,
  "status": 200,
  "message": "کد تایید به شماره 09123456789 ارسال شد",
  "data": { "section": "OTP" }
}
```

**Error - Invalid phone:**

```json
{
  "success": false,
  "status": 400,
  "message": "خطایی در انجام عملیات رخ داده است",
  "data": null
}
```

### TypeScript Interface

```ts
interface AuthCheckResponse
  extends ApiResponseType<{
    section: "PASSWORD" | "OTP";
  } | null> {}
```

## 2a. Password Login

If response section is `PASSWORD`, use this endpoint:

### Endpoint

```http
POST /api/account/authenticate/password/
```

### Request

```json
{
  "phone": "09123456789",
  "password": "your_password"
}
```

### Response

**Success:**

```json
{
  "success": true,
  "status": 200,
  "message": "با موفقیت وارد شدید",
  "data": null
}
```

**Error - Wrong password:**

```json
{
  "success": false,
  "status": 400,
  "message": "کلمه عبور اشتباه است",
  "data": null
}
```

**Error - Invalid input:**

```json
{
  "success": false,
  "status": 400,
  "message": "خطایی در انجام عملیات رخ داده است",
  "data": null
}
```

### TypeScript Interface

```ts
interface PasswordLoginResponse extends ApiResponseType<null> {}
```

## 2b. OTP Login/Registration

If response section is `OTP`, use this endpoint:

### Endpoint

```http
POST /api/account/authenticate/otp/
```

### Request

```json
{
  "phone": "09123456789",
  "otp": "1234",
  "referral_code": "ABC123"
}
```

### Response

**Success:**

```json
{
  "success": true,
  "status": 200,
  "message": "با موفقیت وارد شدید",
  "data": null
}
```

**Error - Wrong/Expired OTP:**

```json
{
  "success": false,
  "status": 400,
  "message": "کد تایید اشتباه یا منقضی شده است",
  "data": null
}
```

**Error - Invalid input:**

```json
{
  "success": false,
  "status": 400,
  "message": "خطایی در انجام عملیات رخ داده است",
  "data": null
}
```

### TypeScript Interface

```ts
interface OTPLoginResponse extends ApiResponseType<null> {}
```

### Resend OTP

If you need to resend the OTP code, use the dedicated resend endpoint:

**Endpoint:** `POST /api/sms-service/request/otp/`

```json
{
  "phone": "09123456789",
  "otp_usage": "AUTHENTICATE"
}
```

For detailed resend OTP documentation, see [Resend OTP Guide](/docs/4.resend-otp).

## 3. Get Current User

After successful login, get user details:

### Endpoint

```http
GET /api/account/authenticate/current/
```

### Response

**Success:**

```json
{
  "success": true,
  "status": 200,
  "message": "عملیات با موفقیت انجام شد",
  "data": {
    "phone": "09123456789",
    "first_name": "John",
    "last_name": "Doe",
    "has_password": true
  }
}
```

**Error - Not authenticated:**

```json
{
  "success": false,
  "status": 401,
  "message": "شما دسترسی ندارید",
  "data": null
}
```

**Error - Invalid token:**

```json
{
  "success": false,
  "status": 401,
  "message": "توکن نا معتبر است",
  "data": null
}
```

## 4. Logout

### Endpoint ( credentials Required )

```http
POST /api/account/authenticate/logout/
```

### Response

**Success:**

```json
{
  "success": true,
  "status": 200,
  "message": "عملیات با موفقیت انجام شد",
  "data": null
}
```

**Error - Not authenticated:**

```json
{
  "success": false,
  "status": 401,
  "message": "شما دسترسی ندارید",
  "data": null
}
```

**Error - Invalid token:**

```json
{
  "success": false,
  "status": 401,
  "message": "توکن نا معتبر است",
  "data": null
}
```

## 5. Token Refresh

### Endpoint

```http
POST /api/account/authenticate/token-refresh/
```

### Request

**No request body needed** - refresh token is read from cookies automatically.

```json
{}
```

### Response

**Success:**

```json
{
  "success": true,
  "status": 200,
  "message": null,
  "data": null
}
```

**Error - No refresh token:**

```json
{
  "success": false,
  "status": 400,
  "message": "دوباره وارد حساب کاربری خود شوید",
  "data": null
}
```

**Error - Token expired:**

```json
{
  "success": false,
  "status": 401,
  "message": "دوباره وارد حساب کاربری خود شوید",
  "data": null
}
```

**Error - Invalid token:**

```json
{
  "success": false,
  "status": 400,
  "message": "خطای نامشخصی رخ داده است.",
  "data": null
}
```

### Cookies Updated on Success

Only these cookies are updated on successful token refresh:

```http
Set-Cookie: access_token=<new_jwt_access_token>; HttpOnly; Secure; SameSite=Lax
Set-Cookie: access_exp=<new_timestamp>; Secure; SameSite=Lax
```

**Note:** The refresh token cookie remains unchanged and is reused.

## Notes

- **HTTP-Only Cookies**: All successful login responses set secure HTTP-only cookies:

  - `access_token`: JWT access token (httpOnly: true)
  - `refresh_token`: JWT refresh token (httpOnly: true)
  - `access_exp`: Access token expiration timestamp (readable by frontend)

- **Automatic OTP**: OTP is automatically sent when section is `OTP`
- **User Creation**: If user doesn't exist, OTP authentication will create new account
- **Referral Code**: Optional for new registrations (6 characters)
- **Token Refresh**: Can read refresh token from cookies automatically
- **Cookie Security**: Cookies are set with `secure` and `samesite` flags in production

## Cookie Details

### Set on Login Success

```http
Set-Cookie: access_token=<jwt>; Max-Age=300; HttpOnly; Secure; SameSite=Lax
Set-Cookie: refresh_token=<jwt>; Max-Age=31536000; HttpOnly; Secure; SameSite=Lax
Set-Cookie: access_exp=<timestamp>; Max-Age=300; Secure; SameSite=Lax
```

### Cleared on Logout

```http
Set-Cookie: access_token=; Max-Age=0; HttpOnly; Secure; SameSite=Lax
Set-Cookie: refresh_token=; Max-Age=0; HttpOnly; Secure; SameSite=Lax
Set-Cookie: access_exp=; Max-Age=0; Secure; SameSite=Lax
```
